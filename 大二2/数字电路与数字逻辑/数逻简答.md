执行时间$CPI\times指令数\times时钟周期$

复杂指令集CISC（字长不等），精简指令集RISC（字长相等），最简指令集URISC

寻址方式：寄存器寻址、立即数寻址、基址（基址-偏移）寻址、PC相对寻址、伪直接寻址

跳转范围：beq为$-2^{15}\sim 2^{15}-1$，j为$0\sim 2^{26}-1$（单位为word）

多周期处理器状态表：

![09-微处理器Part2-2022.pdf 和另外 11 个页面 - 个人 - Microsoft Edge 2022_6_10 19_36_39](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/09-%E5%BE%AE%E5%A4%84%E7%90%86%E5%99%A8Part2-2022.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%2011%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2019_36_39.png)

状态转移图：

![09-微处理器Part2-2022.pdf 和另外 11 个页面 - 个人 - Microsoft Edge 2022_6_10 19_38_07](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/09-%E5%BE%AE%E5%A4%84%E7%90%86%E5%99%A8Part2-2022.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%2011%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2019_38_07.png)

三种异常：访存错误、算术溢出、未知指令

异常为内部不可预测事件，如溢出（同步事件，一种特殊异常）

中断为外部不可预知事件，如I/O（异步事件）

处理异常的步骤：①记录产生异常的指令地址并保存用户程序状态；②利用异常处理程序处理异常；③异常处理结束，将控制交还给用户程序并恢复用户程序状态。（增加原因Cause寄存器和EPC(Exception program counter)寄存器，分别保存造成异常的原因和造成异常的指令地址）（当检测到异常，则清空正在执行的所有内容并进入异常处理程序）

流水线为指令级并行处理

加速比：不使用流水线所用的时间与使用流水线所用的时间的比值

**流水线冒险**：

- 控制冒险：取指令依赖于流水线中指令的结果，因跳转分支指令使得PC无法及时确定
- 数据冒险：指令依赖于流水线中运行的其他指令结果
- 结构冒险：两条指令需要使用同样的硬件

对不同冒险的处理：

- 控制冒险：增加运算单元（PC+4和ALU运算分离），采用指令存储器和数据存储器分离的哈佛体系结构，不让R类型指令在MEM阶段写入数据
- 数据冒险：使寄存器堆支持先写后读，（要求RAW，不能在未写入时读取，比较常见的数据冲突）加入前前条指令的MEM/EX和前一条指令EX/MEM到ALU输入的转发，加入阻塞控制处理load-use冒险，加入延迟槽减少阻塞
- 控制冒险：阻塞，延迟槽减少阻塞，将beq的分支判断提前到ID阶段（这会导致当beq依赖前一条指令的数据时需要进行阻塞，同时后面也必须加一个阻塞)，beq采用静态预测（总认为跳转或不跳转）或者动态预测（建立BHT和BTB，利用历史信息判断是否跳转）（采用预测后，就不需要阻塞了），jump后阻塞一个周期

beq没有提前分支判断的状态表：

![11-流水线part2-2022.pdf 和另外 1 个页面 - 个人 - Microsoft Edge 2022_6_10 22_29_52](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/11-%E6%B5%81%E6%B0%B4%E7%BA%BFpart2-2022.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%201%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2022_29_52.png)

将beq和j指令提前到ID后的状态表：

![12-流水线part3-2022-notes.pdf 和另外 9 个页面 - 个人 - Microsoft Edge 2022_6_10 20_50_34](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/12-%E6%B5%81%E6%B0%B4%E7%BA%BFpart3-2022-notes.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%209%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2020_50_34.png)

前一条指令转发判定：

![11-流水线part2-2022.pdf 和另外 9 个页面 - 个人 - Microsoft Edge 2022_6_10 20_40_47](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/11-%E6%B5%81%E6%B0%B4%E7%BA%BFpart2-2022.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%209%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2020_40_47.png)

前前一条指令转发判定：

![11-流水线part2-2022.pdf 和另外 9 个页面 - 个人 - Microsoft Edge 2022_6_10 20_43_00](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/11-%E6%B5%81%E6%B0%B4%E7%BA%BFpart2-2022.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%209%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2020_43_00.png)

load-use检测：

![11-流水线part2-2022.pdf 和另外 9 个页面 - 个人 - Microsoft Edge 2022_6_10 20_44_29](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/11-%E6%B5%81%E6%B0%B4%E7%BA%BFpart2-2022.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%209%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2020_44_29.png)

进一步提升处理器性能：

- 指令级并行：超级流水线（分级更高），多发射（同时执行多条指令，分静态(超长指令字)和动态(超标量，顺序发射顺序完成、顺序发射乱序完成、乱序发射乱序完成)）
- 线程级并行：超线程，多核
- 异构计算：GPU（单指令流多数据流，并行度高，而CPU为单指令流单数据流），XPU，NPU

超标量的数据冒险：WAR、WAW、RAW（WAW和WAR本质上是共享资源冲突使用，可以通过增加硬件资源，即寄存器重命名解决）



ROM为只读存储器，RAM为随机访问存储器

SRAM结构：（缓存，速度快，稳定，但是晶体管多，造价贵）

![13-存储器实现Part1-2022-withNotes&Corrections.pdf 和另外 8 个页面 - 个人 - Microsoft Edge 2022_6_10 21_14_26](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/13-%E5%AD%98%E5%82%A8%E5%99%A8%E5%AE%9E%E7%8E%B0Part1-2022-withNotes&Corrections.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%208%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2021_14_26.png)

DRAM结构：（主存，速度慢，需要刷新，但是造价低廉）

![13-存储器实现Part1-2022-withNotes&Corrections.pdf 和另外 8 个页面 - 个人 - Microsoft Edge 2022_6_10 21_17_21](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/13-%E5%AD%98%E5%82%A8%E5%99%A8%E5%AE%9E%E7%8E%B0Part1-2022-withNotes&Corrections.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%208%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2021_17_21.png)

存储器参数：

- 容量
- 速度：访问时间$T_A$（申请读取到读取到的时间），存储周期$T_M$（连续两次访问所需最小时间间隔），带宽$B_M$（单位时间内读取或写入的数据量，$\frac{w}{T_M}$，$w$为数据总线宽度）
- 成本：每比特价格



时间局限性：最近的将来要用到的信息很可能就是现在正在使用的信息。主要由循环造成

空间局限性：最近的将来要用到的信息很可能与现在正在使用的信息在空间上是邻近的。主要由顺序执行和数据的聚集存放造成

设计层次化存储器结构使得读取速度加快

主存中的地址按照连续**字节**(byte)存储，cashe按照行存储，行中有数个**字节**，主存按照行的大小分为块，每次移动一个块的数据

cache地址映像方式：（注意**主存地址**的划分）

- 直接映像（主存分成块，再分成区域）（块内地址等价于行内地址）
- 全相联映像（主存分成块，不需要分区域）
- 级相联映像（主存分成块，再分成区域）

（标签理论上可以区分所有行，实际只需要区分组内的行即可)

![13-存储器实现Part1-2022-withNotes&Corrections.pdf 和另外 8 个页面 - 个人 - Microsoft Edge 2022_6_10 21_40_41 (2)](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/13-%E5%AD%98%E5%82%A8%E5%99%A8%E5%AE%9E%E7%8E%B0Part1-2022-withNotes&Corrections.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%208%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2021_40_41%20(2).png)

每个cache行有一个有效标志位v，为1表示该副本有效

行替换（主存块对应的cache行均被占用，即有效标志位都为1时）：（如果是级相联或者全相联需要确定替换原则）随机法，先进先出法(FIFO)，最近最少使用法(LRU)

数据更新（当需要向层次结构存储器写入数据，需要确定是写入cache还是主存）：写通过（缓存和主存都写入，使其数据一致，且硬件实现简单），写回（先将数据写入cache，在被替换时，将所存数据写入存储器，这样需要引入脏位D，存在缓存和主存不一致的情况）

脏位为1表示cache中数据被更新，但是还未写回到主存中

![14-存储器设计Part2-2022-with_Correction&Notes.pdf 和另外 11 个页面 - 个人 - Microsoft Edge 2022_6_10 22_03_29](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/14-%E5%AD%98%E5%82%A8%E5%99%A8%E8%AE%BE%E8%AE%A1Part2-2022-with_Correction&Notes.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%2011%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2022_03_29.png)

cache性能评估（3C原则）：

- 强迫性缺失：第一次访问主存储器中的某一个数据块，只能先从主存储器将数据加载到cache中，也称为冷启动缺失或首次访问失效（次数等于主存块数量）
- 容量缺失：由于cache容纳不了程序所需的所有主存块而引起的缺失
- 冲突缺失：在组相联或者直接映像中，多个的主存块竞争同一个cache组时引起的缺失，也称碰撞缺失（前提：cache未满）（只出现在级相联和直接映射缓存中）

![14-存储器设计Part2-2022-with_Correction&Notes.pdf 和另外 11 个页面 - 个人 - Microsoft Edge 2022_6_10 22_07_51](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/14-%E5%AD%98%E5%82%A8%E5%99%A8%E8%AE%BE%E8%AE%A1Part2-2022-with_Correction&Notes.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%2011%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2022_07_51.png)

![14-存储器设计Part2-2022-with_Correction&Notes.pdf 和另外 11 个页面 - 个人 - Microsoft Edge 2022_6_10 22_09_05](C:/Users/%E6%83%A0%E6%99%AE/Videos/Captures/14-%E5%AD%98%E5%82%A8%E5%99%A8%E8%AE%BE%E8%AE%A1Part2-2022-with_Correction&Notes.pdf%20%E5%92%8C%E5%8F%A6%E5%A4%96%2011%20%E4%B8%AA%E9%A1%B5%E9%9D%A2%20-%20%E4%B8%AA%E4%BA%BA%20-%20Microsoft%E2%80%8B%20Edge%202022_6_10%2022_09_05.png)

提高cache性能：

- 处理器速度加快（提高时钟频率或者降低CPI），存储器阻塞的影响增大
- 改变cache容量和行大小
- 利用组相联降低缺失率
- 利用多级cache策略降低缺失损失（L1 Cache减少命中时间，L2 Cache降低缺失率）



总线负责在设备间传输数据，以及传输和数据相关的地址信号和控制信号

总线基本参数：

- 总线宽度：总线中传输线的数量
- 总线传输频率：总线上数据传输时的频率
- 标准传输率：总线上单位时间能够传输的最大数据量
- 负载能力：正常工作前提下，总线能够挂载的设备数目

总线划分：

- 单总线结构：结构简单，易于扩展，但是整体通信效率低
- 双总线结构：保证了存储器和处理器之间的高效通信
- 多总线结构



主动发起基于总线的数据传输成为主设备，另外一个设备称为从设备

主线上的每个设备都有自己独一无二的设备地址

总线一般采用申请-使用流程，总线空闲时才能使用

总线传输信息四个阶段：

- 申请阶段（总线仲裁器，集中式，分布式）
- 寻址阶段
- 传输阶段
- 结束阶段



集中式仲裁系统可划分为：

- 链式查询：按照硬件顺序依次查询
- 计数器查询：按计数器顺序逐步查询设备
- 总线独立请求与准许：每个设备和总线仲裁器均有独立的连接



分布式仲裁系统：总线判优的控制逻辑分散在于总线相连的各个设备上



驱动程序

特殊指令访问

内存映射地址访问

和处理器通信：特殊指令访问，内存映射地址访问

和CPU通信方式：轮询式，中断式





